let editor,currentTheme="vs",files={},activeFile="Main.java",isExecuting=!1;function initializeMonacoEditor(){if("undefined"!=typeof monaco)return void createEditor();const e=["https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs","https://unpkg.com/monaco-editor@0.41.0/min/vs","https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs"];let t=0;!function n(){t>=e.length?createFallbackEditor():(require.config({paths:{vs:e[t]},"vs/nls":{availableLanguages:{"*":"ru"}}}),require(["vs/editor/editor.main"],createEditor,(function(i){console.warn(`Failed to load Monaco from ${e[t]}:`,i),t++,"undefined"!=typeof requirejs&&requirejs.undef("vs/editor/editor.main"),setTimeout(n,500)})))}()}function createEditor(){editor=monaco.editor.create(document.getElementById("editor"),{value:getDefaultJavaCode(),language:"java",theme:currentTheme,automaticLayout:!0,fontSize:14,tabSize:4,wordWrap:"on",minimap:{enabled:!1},scrollBeyondLastLine:!1,renderWhitespace:"selection",lineNumbers:"on",folding:!0,bracketMatching:"always",autoClosingBrackets:"always",autoClosingQuotes:"always",formatOnPaste:!0,formatOnType:!0}),editor.onDidChangeCursorPosition((function(e){document.getElementById("cursorPos").textContent=`Строка: ${e.position.lineNumber}, Столбец: ${e.position.column}`})),editor.onDidChangeModelContent((function(){activeFile&&(files[activeFile]=editor.getValue(),updateTabStatus(activeFile,!0))})),editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyS,saveCurrentFile),editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.Enter,runCode),setStatus("Редактор загружен")}function createFallbackEditor(){console.warn("Monaco Editor failed to load, using fallback textarea"),document.getElementById("editor").innerHTML=`\n        <textarea id="fallbackEditor" style="\n            width: 100%; height: 100%; border: none; outline: none; \n            font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; \n            padding: 10px; resize: none; background: #1e1e1e; color: #d4d4d4; \n            tab-size: 4;\n        ">${getDefaultJavaCode()}</textarea>\n    `;const e=document.getElementById("fallbackEditor");editor={getValue:()=>e.value,setValue:t=>{e.value=t},updateOptions:()=>{},onDidChangeCursorPosition:()=>{},onDidChangeModelContent:t=>{e.addEventListener("input",t)},addCommand:()=>{}},e.addEventListener("input",(function(){activeFile&&(files[activeFile]=e.value,updateTabStatus(activeFile,!0))})),setStatus("Использован упрощенный редактор")}function initializeEventListeners(){document.getElementById("runBtn").addEventListener("click",runCode),document.getElementById("saveBtn").addEventListener("click",saveCurrentFile),document.getElementById("clearBtn").addEventListener("click",clearOutput),document.getElementById("clearOutputBtn").addEventListener("click",clearOutput),document.getElementById("newProject").addEventListener("click",newProject),document.getElementById("openBtn").addEventListener("click",(()=>{document.getElementById("fileInput").click()})),document.getElementById("downloadBtn").addEventListener("click",downloadCurrentFile),document.getElementById("fileInput").addEventListener("change",handleFileOpen),document.getElementById("themeToggle").addEventListener("click",toggleTheme),document.getElementById("settingsBtn").addEventListener("click",openSettings),document.getElementById("closeSettingsModal").addEventListener("click",closeSettings),document.getElementById("cancelSettingsBtn").addEventListener("click",closeSettings),document.getElementById("saveSettingsBtn").addEventListener("click",saveSettings),document.getElementById("examplesBtn").addEventListener("click",toggleExamplesDropdown),document.getElementById("examplesDropdown").addEventListener("click",handleExampleSelect),document.getElementById("addTab").addEventListener("click",openNewFileModal),document.getElementById("tabContainer").addEventListener("click",handleTabClick),document.getElementById("closeNewFileModal").addEventListener("click",closeNewFileModal),document.getElementById("cancelNewFileBtn").addEventListener("click",closeNewFileModal),document.getElementById("createNewFileBtn").addEventListener("click",createNewFile),document.getElementById("helpBtn").addEventListener("click",openHelp),document.getElementById("closeHelpModal").addEventListener("click",closeHelp),document.addEventListener("click",(function(e){e.target.classList.contains("modal")&&(e.target.style.display="none"),e.target.closest(".examples-dropdown")||(document.getElementById("examplesDropdown").style.display="none")}))}function initializeFiles(){files["Main.java"]=getDefaultJavaCode(),updateTabDisplay()}function getDefaultJavaCode(){return'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World!");\n        \n        java.util.Scanner scanner = new java.util.Scanner(System.in);\n        System.out.print("Enter your name: ");\n        String name = scanner.nextLine();\n        System.out.println("Hello " + name + "!");\n    }\n}'}async function runCode(){if(isExecuting)return;const e=editor.getValue();if(!e.trim())return void showError("Код не может быть пустым");clearOutput();const t=document.getElementById("inputConsole").value;showLoading(!0),setStatus("Компиляция и выполнение..."),isExecuting=!0;try{const n=await fetch("https://emkc.org/api/v2/piston/execute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({language:"java",version:"15.0.2",files:[{name:activeFile,content:e}],stdin:t,compile_timeout:1e4,run_timeout:3e3,compile_memory_limit:-1,run_memory_limit:-1})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);displayOutput(await n.json()),setStatus("Выполнено")}catch(e){console.error("Execution error:",e),showError("Ошибка выполнения: "+e.message),setStatus("Ошибка")}finally{showLoading(!1),isExecuting=!1}}function displayOutput(e){const t=document.getElementById("output");if(e.compile&&0!==e.compile.code){const n=document.createElement("div");return n.className="error-output",n.innerHTML=`<strong>Ошибка компиляции:</strong><br>${escapeHtml(e.compile.stderr||e.compile.stdout)}`,void t.appendChild(n)}if(e.run){if(e.run.stdout){const n=document.createElement("div");n.className="stdout-output",n.textContent=e.run.stdout,t.appendChild(n)}if(e.run.stderr){const n=document.createElement("div");n.className="error-output",n.innerHTML=`<strong>Ошибка выполнения:</strong><br>${escapeHtml(e.run.stderr)}`,t.appendChild(n)}if(0!==e.run.code){const n=document.createElement("div");n.className="exit-code",n.textContent=`Код завершения: ${e.run.code}`,t.appendChild(n)}}t.scrollTop=t.scrollHeight}function clearOutput(){document.getElementById("output").innerHTML="",setStatus("Консоль очищена")}function showLoading(e){document.getElementById("loading").style.display=e?"flex":"none"}function showError(e){const t=document.getElementById("output"),n=document.createElement("div");n.className="error-output",n.innerHTML=`<strong>Ошибка:</strong> ${escapeHtml(e)}`,t.appendChild(n),t.scrollTop=t.scrollHeight}function setStatus(e){document.getElementById("statusMessage").textContent=e}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function saveCurrentFile(){if(activeFile&&void 0!==files[activeFile]){files[activeFile]=editor.getValue(),updateTabStatus(activeFile,!1),setStatus("Файл сохранен");try{const e=JSON.parse(localStorage.getItem("javaIDEFiles")||"{}");e[activeFile]=files[activeFile],localStorage.setItem("javaIDEFiles",JSON.stringify(e))}catch(e){console.warn("Could not save to localStorage:",e)}}}function downloadCurrentFile(){if(!activeFile||!files[activeFile])return;const e=new Blob([files[activeFile]],{type:"text/plain;charset=utf-8"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=activeFile,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}function handleFileOpen(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){const n=t.name,i=e.target.result;files[n]=i,switchToFile(n),updateTabDisplay(),setStatus(`Файл ${n} загружен`)},n.readAsText(t,"UTF-8")}function newProject(){confirm("Создать новый проект? Несохраненные изменения будут потеряны.")&&(files={},files["Main.java"]=getDefaultJavaCode(),activeFile="Main.java",editor.setValue(files[activeFile]),updateTabDisplay(),clearOutput(),setStatus("Новый проект создан"))}function toggleTheme(){currentTheme="vs-dark"===currentTheme?"vs":"vs-dark",applyTheme(),saveTheme()}function saveTheme(){try{localStorage.setItem("javaIDETheme",currentTheme)}catch(e){console.warn("Could not save theme:",e)}}function applyTheme(){const e=document.body,t=document.querySelector("#themeToggle i");"vs-dark"===currentTheme?(e.classList.add("dark-theme"),t.className="fas fa-sun"):(e.classList.remove("dark-theme"),t.className="fas fa-moon"),editor&&monaco.editor.setTheme(currentTheme)}function toggleExamplesDropdown(){const e=document.getElementById("examplesDropdown");e.style.display="block"===e.style.display?"none":"block"}function handleExampleSelect(e){if(e.target.dataset.example){const t=getExampleCode(e.target.dataset.example);files[activeFile]=t,editor.setValue(t),updateTabStatus(activeFile,!0),document.getElementById("examplesDropdown").style.display="none",setStatus(`Пример "${e.target.textContent}" загружен`)}}function getExampleCode(e){return{"hello-world":'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, World!");\n    }\n}',fibonacci:'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Fibonacci numbers:");\n        \n        int n = 10;\n        int a = 0, b = 1;\n        \n        System.out.print(a + " " + b + " ");\n        \n        for (int i = 2; i < n; i++) {\n            int c = a + b;\n            System.out.print(c + " ");\n            a = b;\n            b = c;\n        }\n        System.out.println();\n    }\n}',sorting:'import java.util.Arrays;\n\npublic class Main {\n    public static void main(String[] args) {\n        int[] arr = {64, 34, 25, 12, 22, 11, 90};\n        \n        System.out.println("Original array:");\n        System.out.println(Arrays.toString(arr));\n        \n        bubbleSort(arr);\n        \n        System.out.println("Sorted array:");\n        System.out.println(Arrays.toString(arr));\n    }\n    \n    static void bubbleSort(int[] arr) {\n        int n = arr.length;\n        for (int i = 0; i < n - 1; i++) {\n            for (int j = 0; j < n - i - 1; j++) {\n                if (arr[j] > arr[j + 1]) {\n                    int temp = arr[j];\n                    arr[j] = arr[j + 1];\n                    arr[j + 1] = temp;\n                }\n            }\n        }\n    }\n}',calculator:'import java.util.Scanner;\n\npublic class Main {\n    public static void main(String[] args) {\n        Scanner scanner = new Scanner(System.in);\n        \n        System.out.println("Simple Calculator");\n        System.out.print("Enter first number: ");\n        double num1 = scanner.nextDouble();\n        \n        System.out.print("Enter operation (+, -, *, /): ");\n        char operation = scanner.next().charAt(0);\n        \n        System.out.print("Enter second number: ");\n        double num2 = scanner.nextDouble();\n        \n        double result;\n        switch (operation) {\n            case \'+\':\n                result = num1 + num2;\n                break;\n            case \'-\':\n                result = num1 - num2;\n                break;\n            case \'*\':\n                result = num1 * num2;\n                break;\n            case \'/\':\n                if (num2 != 0) {\n                    result = num1 / num2;\n                } else {\n                    System.out.println("Error: Division by zero!");\n                    return;\n                }\n                break;\n            default:\n                System.out.println("Invalid operation!");\n                return;\n        }\n        \n        System.out.printf("Result: %.2f\\n", result);\n    }\n}',stringUtils:'public class Main {\n    public static void main(String[] args) {\n        String text = "Hello, World!";\n        \n        System.out.println("Original string: " + text);\n        System.out.println("Length: " + text.length());\n        System.out.println("Upper case: " + text.toUpperCase());\n        System.out.println("Lower case: " + text.toLowerCase());\n        \n        System.out.println("\\nWord breakdown:");\n        String[] words = text.split(" ");\n        for (int i = 0; i < words.length; i++) {\n            System.out.println((i + 1) + ": " + words[i]);\n        }\n        \n        System.out.println("\\nReversed string:");\n        System.out.println(reverse(text));\n    }\n    \n    static String reverse(String str) {\n        StringBuilder sb = new StringBuilder(str);\n        return sb.reverse().toString();\n    }\n}'}[e]||getDefaultJavaCode()}function handleTabClick(e){if(e.target.classList.contains("tab-close"))closeTab(e.target.parentElement.dataset.file);else if(e.target.classList.contains("tab")||e.target.parentElement.classList.contains("tab")){const t=(e.target.classList.contains("tab")?e.target:e.target.parentElement).dataset.file;t&&switchToFile(t)}}function switchToFile(e){activeFile&&(files[activeFile]=editor.getValue()),activeFile=e,editor.setValue(files[e]||""),updateTabDisplay(),setStatus(`Переключено на ${e}`)}function closeTab(e){1!==Object.keys(files).length?(files[e]===editor.getValue()||e!==activeFile||confirm("Файл не сохранен. Закрыть без сохранения?"))&&(delete files[e],e===activeFile&&(activeFile=Object.keys(files)[0],editor.setValue(files[activeFile])),updateTabDisplay()):alert("Нельзя закрыть последний файл")}function updateTabDisplay(){const e=document.getElementById("tabContainer");e.querySelectorAll(".tab").forEach((e=>e.remove())),Object.keys(files).forEach((t=>{const n=document.createElement("div");n.className="tab"+(t===activeFile?" active":""),n.dataset.file=t;const i=document.createElement("div");i.className="tab-title",i.textContent=t;const a=document.createElement("div");a.className="tab-close",a.innerHTML="&times;",n.appendChild(i),n.appendChild(a),e.insertBefore(n,document.getElementById("addTab"))}))}function updateTabStatus(e,t){const n=document.querySelector(`[data-file="${e}"]`);if(n){const i=e+(t?" •":"");n.querySelector(".tab-title").textContent=i}}function openNewFileModal(){document.getElementById("newFileModal").style.display="block",document.getElementById("fileNameInput").focus()}function closeNewFileModal(){document.getElementById("newFileModal").style.display="none"}function createNewFile(){const e=document.getElementById("fileNameInput").value.trim();if(!e)return void alert("Введите имя файла");if(!e.endsWith(".java"))return void alert("Имя файла должно заканчиваться на .java");if(files[e])return void alert("Файл с таким именем уже существует");const t=e.replace(".java","");files[e]=`public class ${t} {\n    public static void main(String[] args) {\n        System.out.println("Hello from ${t}!");\n    }\n}`,switchToFile(e),updateTabDisplay(),closeNewFileModal(),setStatus(`Файл ${e} создан`)}function openSettings(){document.getElementById("settingsModal").style.display="block",loadCurrentSettings()}function closeSettings(){document.getElementById("settingsModal").style.display="none"}function loadCurrentSettings(){const e=editor.getOptions();document.getElementById("fontSizeSelect").value=e.get(monaco.editor.EditorOption.fontSize),document.getElementById("tabSizeSelect").value=e.get(monaco.editor.EditorOption.tabSize),document.getElementById("wordWrapSelect").value=e.get(monaco.editor.EditorOption.wordWrap),document.getElementById("themeSelect").value=currentTheme}function saveSettings(){const e=parseInt(document.getElementById("fontSizeSelect").value),t=parseInt(document.getElementById("tabSizeSelect").value),n=document.getElementById("wordWrapSelect").value,i=document.getElementById("themeSelect").value;editor.updateOptions({fontSize:e,tabSize:t,wordWrap:n}),i!==currentTheme&&(currentTheme=i,monaco.editor.setTheme(currentTheme),applyTheme());try{const i={fontSize:e,tabSize:t,wordWrap:n,theme:currentTheme};localStorage.setItem("javaIDESettings",JSON.stringify(i))}catch(e){console.warn("Could not save settings:",e)}closeSettings(),setStatus("Настройки сохранены")}function loadSettings(){try{const e=localStorage.getItem("javaIDETheme");e&&(currentTheme=e),JSON.parse(localStorage.getItem("javaIDESettings")||"{}");const t=JSON.parse(localStorage.getItem("javaIDEFiles")||"{}");Object.keys(t).length>0&&(files={...files,...t})}catch(e){console.warn("Could not load settings:",e)}}function openHelp(){document.getElementById("helpModal").style.display="block"}function closeHelp(){document.getElementById("helpModal").style.display="none"}document.addEventListener("DOMContentLoaded",(function(){setStatus("Загрузка редактора..."),initializeEventListeners(),initializeFiles(),loadSettings(),applyTheme(),setTimeout((()=>{initializeMonacoEditor()}),100)}));